// ... (ìƒë‹¨ HTML/CSSëŠ” ë™ì¼)

// [ìˆ˜ì •ëœ input ìƒì„± ë¶€ë¶„]
puzzle.forEach((val) => {
    const cell = document.createElement('div');
    cell.className = 'cell';
    if(val !== 0) {
        cell.classList.add('fixed');
        cell.innerText = val;
    } else {
        const input = document.createElement('input');
        input.type = 'number';
        input.inputMode = 'numeric';
        
        // ì…ë ¥ ì‹œë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ë¡œì§
        input.oninput = function() {
            if(!gameStarted) startTimer();
            if(this.value.length > 1) this.value = this.value.slice(0,1);
            
            // ì‹¤ì‹œê°„ ì²´í¬: ëª¨ë“  inputì´ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
            checkAllFilledAndVerify();
        };
        cell.appendChild(input);
    }
    board.appendChild(cell);
});

// [ìƒˆë¡œ ì¶”ê°€ëœ ìë™ ì²´í¬ í•¨ìˆ˜]
function checkAllFilledAndVerify() {
    const inputs = document.querySelectorAll('.cell input');
    // ëª¨ë“  inputì— ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
    const allFilled = Array.from(inputs).every(el => el.value !== "");
    
    if (allFilled) {
        // ëª¨ë“  ì¹¸ì´ ì±„ì›Œì¡Œë‹¤ë©´ 0.1ì´ˆ ë’¤ì— ì •ë‹µ í™•ì¸ ì‹¤í–‰ (ìˆ«ìê°€ ì¨ì§€ëŠ”ê±¸ ë³´ì—¬ì£¼ê¸° ìœ„í•¨)
        setTimeout(() => {
            finishGame(true); // ìë™ ì‹¤í–‰ì„ì„ ì•Œë¦¬ëŠ” íŒŒë¼ë¯¸í„°
        }, 100);
    }
}

// [ìˆ˜ì •ëœ finishGame í•¨ìˆ˜]
function finishGame(isAuto = false) {
    const size = config[currentLevel].size;
    const cells = document.querySelectorAll('.cell');
    let userData = [];
    
    // ë°ì´í„° ìˆ˜ì§‘
    for(let i=0; i<size; i++) {
        let row = [];
        for(let j=0; j<size; j++) {
            const cell = cells[i * size + j];
            const val = cell.classList.contains('fixed') ? cell.innerText : cell.querySelector('input').value;
            
            // ìˆ˜ë™ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ "ëª¨ë“  ì¹¸ ì±„ìš°ê¸°" ê²½ê³ ì°½ í‘œì‹œ
            if(!val) { 
                if(!isAuto) alert("ëª¨ë“  ì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”!"); 
                return; 
            }
            row.push(parseInt(val));
        }
        userData.push(row);
    }

    // ê²€ì¦ ë¡œì§ (ì¤‘ë³µ ì²´í¬)
    for(let i=0; i<size; i++) {
        let rowSet = new Set(), colSet = new Set();
        for(let j=0; j<size; j++) {
            if(rowSet.has(userData[i][j]) || userData[i][j] < 1 || userData[i][j] > size) {
                if(!isAuto) alert("ê°€ë¡œ ì¤„ì— ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤!");
                return;
            }
            rowSet.add(userData[i][j]);
            if(colSet.has(userData[j][i])) {
                if(!isAuto) alert("ì„¸ë¡œ ì¤„ì— ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤!");
                return;
            }
            colSet.add(userData[j][i]);
        }
    }

    // ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ ì •ë‹µ!
    clearInterval(timerInterval);
    const time = document.getElementById('timer').innerText;
    
    // ë¦¬í¬íŠ¸ ì—°ë™ìš© ì ìˆ˜ ê³„ì‚°
    let logicScore = Math.max(50, 100 - (parseFloat(time) / currentLevel));
    localStorage.setItem('game2_score', Math.round(logicScore));
    
    let history = JSON.parse(localStorage.getItem('sudokuHistory')) || [];
    history.unshift({ info: `Lv.${currentLevel}`, time: time + 's' });
    localStorage.setItem('sudokuHistory', JSON.stringify(history.slice(0, 5)));

    if(confirm(`ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤! (ìë™ ì²´í¬)\nê¸°ë¡: ${time}ì´ˆ\në¶„ì„ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        location.href = 'report.html';
    } else {
        initGame();
    }
}
